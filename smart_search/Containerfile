FROM registry.redhat.io/ubi9/python-311:9.6

WORKDIR /app

# Install CPU-only PyTorch first (before sentence-transformers pulls GPU version)
RUN pip install --no-cache-dir torch --index-url https://download.pytorch.org/whl/cpu

# Install dependencies
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Copy application
COPY smart_search_mcp.py ./

# Bundle config and databases
COPY dump_config.json ./
COPY db/ ./db/

# Environment variables
ENV MCP_TRANSPORT=stdio
ENV DB_PATH=/app/db
ENV COLLECTION_NAME=slack_messages
ENV EMBEDDING_MODEL=all-MiniLM-L6-v2
ENV WORKSPACE_URL=https://redhat-internal.slack.com
ENV TOP_K=10

CMD ["python", "smart_search_mcp.py"]
